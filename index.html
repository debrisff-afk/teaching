<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®¶è¾‰åŸ¹ä¼˜ - æ•™å­¦ç£å¯¼ç®¡ç†ç³»ç»Ÿ</title>
    
    <!-- ç¬¬ä¸‰æ–¹åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Tailwind è‡ªå®šä¹‰é…ç½® -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        jhblue: '#009FE8', // å®¶è¾‰è“
                        jhorange: '#FF6B6B', // æ´»åŠ›æ©™
                    }
                }
            }
        }
    </script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, setDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ================= å…¨å±€çŠ¶æ€ç®¡ç† =================
        let isLocalMode = false;
        let db = null;
        let auth = null;
        let firebaseUser = null; // Firebase å±‚çš„ç”¨æˆ·
        let appUser = null;      // åº”ç”¨å±‚çš„ç”¨æˆ· (åŒ…å«è§’è‰²ä¿¡æ¯)
        let appId = 'default-app-id';
        let allUsers = [];       // ç®¡ç†å‘˜ç”¨çš„ç”¨æˆ·åˆ—è¡¨ç¼“å­˜

        // åˆå§‹åŒ–å‡½æ•°
        async function initSystem() {
            if (typeof __firebase_config === 'undefined') {
                console.warn("âš ï¸ æœ¬åœ°æ¨¡å¼");
                isLocalMode = true;
                checkLocalLogin();
                return;
            }

            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        firebaseUser = user;
                        await checkCloudLogin(user.uid);
                    }
                });

            } catch (e) {
                console.error("Firebase Error:", e);
                isLocalMode = true;
                checkLocalLogin();
            }
        }

        // ================= è´¦æˆ·ä¸æƒé™é€»è¾‘ =================

        // æ£€æŸ¥äº‘ç«¯ç™»å½•çŠ¶æ€ (å³æ˜¯å¦å·²ç»åœ¨ public/users æ³¨å†Œè¿‡)
        async function checkCloudLogin(uid) {
            try {
                // Rule 1: Use Public path for shared user data so Admin can manage
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'jh_users');
                const q = query(usersRef);
                const snapshot = await getDocs(q);
                let foundUser = null;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.uid === uid) {
                        foundUser = { ...data, id: doc.id }; // Store doc id for updates
                    }
                });

                if (foundUser) {
                    appUser = foundUser;
                    showApp();
                } else {
                    showLoginModal(); // éœ€è¦æ³¨å†Œ
                }
            } catch (e) {
                console.error("Check login failed:", e);
                showLoginModal();
            }
        }

        function checkLocalLogin() {
            const saved = localStorage.getItem('jh_current_user');
            if (saved) {
                appUser = JSON.parse(saved);
                showApp();
            } else {
                showLoginModal();
            }
        }

        // æ³¨å†Œ/ç™»å½•å¤„ç†
        window.handleLogin = async (name, role) => {
            const newUserData = {
                name: name,
                role: role, // 'supervisor' | 'admin'
                uid: firebaseUser ? firebaseUser.uid : 'local_' + Date.now(),
                createdAt: Date.now()
            };

            if (isLocalMode) {
                localStorage.setItem('jh_current_user', JSON.stringify(newUserData));
                appUser = newUserData;
            } else {
                try {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'jh_users');
                    await addDoc(usersRef, newUserData);
                    appUser = newUserData;
                } catch (e) {
                    alert("æ³¨å†Œå¤±è´¥: " + e.message);
                    return;
                }
            }
            showApp();
        };

        // é€€å‡ºç™»å½•
        window.handleLogout = () => {
            appUser = null;
            if (isLocalMode) localStorage.removeItem('jh_current_user');
            location.reload(); // ç®€å•ç²—æš´åˆ·æ–°ä»¥é‡ç½®çŠ¶æ€
        };

        function showLoginModal() {
            document.getElementById('login-modal').classList.remove('hidden');
            document.getElementById('app-container').classList.add('hidden');
        }

        function showApp() {
            document.getElementById('login-modal').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // æ›´æ–°ä¾§è¾¹æ ç”¨æˆ·ä¿¡æ¯
            document.getElementById('sidebar-username').innerText = appUser.name;
            document.getElementById('sidebar-role').innerText = appUser.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç£å¯¼è€å¸ˆ';
            
            // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºç®¡ç†å…¥å£
            if (appUser.role === 'admin') {
                document.getElementById('nav-admin').classList.remove('hidden');
            } else {
                document.getElementById('nav-admin').classList.add('hidden');
            }

            // é¢„å¡«ç£å¯¼å§“å
            const supervisorInput = document.getElementById('supervisorName');
            if(supervisorInput) supervisorInput.value = appUser.name;

            window.loadEvaluations();
        }

        // ================= æ•°æ®æ“ä½œå±‚ (å¸¦æƒé™è¿‡æ»¤) =================

        window.saveEvaluationToDB = async (data) => {
            const record = {
                ...data,
                creatorId: appUser.uid, // å…³é”®ï¼šç»‘å®šåˆ›å»ºè€…
                creatorName: appUser.name,
                timestamp: Date.now(),
                dateStr: new Date().toLocaleDateString()
            };

            if (isLocalMode) {
                const localData = JSON.parse(localStorage.getItem('jh_evaluations') || '[]');
                record.id = 'local_' + Date.now();
                localData.push(record);
                localStorage.setItem('jh_evaluations', JSON.stringify(localData));
                showToast("âœ… æœ¬åœ°ä¿å­˜æˆåŠŸ");
                await window.loadEvaluations();
            } else {
                try {
                    // Use Public path so Admins can see it too
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'jh_evaluations');
                    await addDoc(colRef, record);
                    showToast("âœ… äº‘ç«¯åŒæ­¥æˆåŠŸ");
                    await window.loadEvaluations();
                } catch (e) {
                    console.error(e);
                    alert("ä¿å­˜å¤±è´¥");
                }
            }
        };

        window.loadEvaluations = async () => {
            let evaluations = [];
            const tbody = document.getElementById('data-table-body');
            if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-slate-400"><i class="fas fa-spinner fa-spin mr-2"></i>åŠ è½½æ•°æ®ä¸­...</td></tr>`;

            try {
                if (isLocalMode) {
                    const raw = localStorage.getItem('jh_evaluations');
                    if (raw) evaluations = JSON.parse(raw);
                } else {
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'jh_evaluations');
                    const q = query(colRef); // Fetch all first, then filter in memory (Rule #2 compliant)
                    const snapshot = await getDocs(q);
                    snapshot.forEach((doc) => {
                        evaluations.push({ id: doc.id, ...doc.data() });
                    });
                }

                // === æƒé™è¿‡æ»¤æ ¸å¿ƒé€»è¾‘ ===
                let filteredEvaluations = evaluations;
                if (appUser.role !== 'admin') {
                    // æ™®é€šç£å¯¼åªçœ‹è‡ªå·±çš„
                    filteredEvaluations = evaluations.filter(e => e.creatorId === appUser.uid);
                }
                // ç®¡ç†å‘˜çœ‹æ‰€æœ‰ (æ— éœ€è¿‡æ»¤)

                // æ’åº
                filteredEvaluations.sort((a, b) => b.timestamp - a.timestamp);
                window.cachedEvaluations = filteredEvaluations;

                // æ¸²æŸ“
                if(window.renderTableGlobal) window.renderTableGlobal(filteredEvaluations);
                if(window.updateDashboardGlobal) window.updateDashboardGlobal(filteredEvaluations);

            } catch (error) {
                console.error(error);
                if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="text-center text-red-400 p-4">æ•°æ®åŠ è½½å¼‚å¸¸</td></tr>`;
            }
        };

        // ================= ç”¨æˆ·ç®¡ç† (ç®¡ç†å‘˜åŠŸèƒ½) =================
        
        window.loadAllUsers = async () => {
            if (appUser.role !== 'admin') return;
            
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '<tr><td colspan="4" class="p-4 text-center">åŠ è½½ä¸­...</td></tr>';

            let users = [];
            if (isLocalMode) {
                // æœ¬åœ°æ¨¡å¼åªèƒ½æ¼”ç¤ºè‡ªå·±
                users = [appUser];
            } else {
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'jh_users');
                const snapshot = await getDocs(query(usersRef));
                snapshot.forEach(doc => users.push({ ...doc.data(), id: doc.id }));
            }
            allUsers = users;
            renderUserTable(users);
        }

        function renderUserTable(users) {
            const tbody = document.getElementById('user-table-body');
            tbody.innerHTML = '';
            users.forEach(u => {
                const isMe = u.uid === appUser.uid;
                tbody.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3">${u.name}</td>
                        <td class="p-3">
                            <span class="px-2 py-1 rounded text-xs ${u.role === 'admin' ? 'bg-purple-100 text-purple-700' : 'bg-blue-100 text-blue-700'}">
                                ${u.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç£å¯¼'}
                            </span>
                        </td>
                        <td class="p-3 text-xs text-gray-500">${new Date(u.createdAt).toLocaleDateString()}</td>
                        <td class="p-3">
                            ${!isMe && !isLocalMode ? `
                            <button onclick="window.toggleUserRole('${u.id}', '${u.role}')" class="text-blue-600 text-xs hover:underline">
                                ${u.role === 'admin' ? 'é™ä¸ºç£å¯¼' : 'è®¾ä¸ºç®¡ç†'}
                            </button>` : '<span class="text-gray-300 text-xs">--</span>'}
                        </td>
                    </tr>
                `;
            });
        }

        window.toggleUserRole = async (docId, currentRole) => {
            const newRole = currentRole === 'admin' ? 'supervisor' : 'admin';
            if(confirm(`ç¡®å®šå°†è¯¥ç”¨æˆ·æƒé™ä¿®æ”¹ä¸º ${newRole === 'admin' ? 'ç®¡ç†å‘˜' : 'æ™®é€šç£å¯¼'} å—ï¼Ÿ`)) {
                try {
                    const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'jh_users', docId);
                    await setDoc(userRef, { role: newRole }, { merge: true });
                    showToast("æƒé™ä¿®æ”¹æˆåŠŸ");
                    window.loadAllUsers();
                } catch(e) {
                    alert("ä¿®æ”¹å¤±è´¥");
                }
            }
        }

        initSystem();
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f0f9ff; } /* ææµ…è“èƒŒæ™¯ */
        
        .nav-item.active { background-color: #e0f2fe; color: #009FE8; border-right: 4px solid #009FE8; }
        .score-input:focus { ring: 2px; ring-color: #009FE8; }
        .check-item { cursor: pointer; user-select: none; transition: all 0.2s; }
        .check-item.checked { color: #009FE8; font-weight: bold; background-color: #e0f2fe; border-color: #009FE8; }
        
        /* Logo SVG æ ·å¼ */
        .logo-icon { width: 40px; height: 40px; }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; transform: translateX(120%); transition: transform 0.3s; }
        #toast-container.show { transform: translateX(0); }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; }
        
        @media print {
            .no-print { display: none !important; }
            #sidebar { display: none !important; }
            #report-view { display: block !important; position: static !important; overflow: visible !important; }
            #input-view, #home-view, #data-view, #tool-view, #admin-view { display: none !important; }
            body { background-color: white; overflow: visible !important; }
        }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800">

    <!-- Toast -->
    <div id="toast-container" class="bg-slate-800 text-white px-6 py-3 rounded-lg shadow-xl flex items-center gap-3">
        <i class="fas fa-check-circle text-jhorange"></i>
        <span id="toast-message">æ“ä½œæˆåŠŸ</span>
    </div>

    <!-- Loading -->
    <div id="loading-overlay">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-slate-200 border-t-jhblue mb-4"></div>
        <div class="text-jhblue font-bold text-lg">å¤„ç†ä¸­...</div>
    </div>

    <!-- ç™»å½•/æ³¨å†Œ Modal -->
    <div id="login-modal" class="fixed inset-0 z-50 bg-slate-900/50 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md mx-4">
            <div class="text-center mb-8">
                <!-- SVG Logo -->
                <svg class="w-16 h-16 mx-auto mb-4" viewBox="0 0 200 60" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M40 10C25 10 15 20 15 35C15 50 25 60 40 60C55 60 65 50 65 35" stroke="#009FE8" stroke-width="8" stroke-linecap="round"/>
                    <circle cx="40" cy="35" r="10" fill="#009FE8"/>
                    <path d="M15 35L5 15L35 25" fill="#FF6B6B"/> <!-- æ©™è‰²ç®­å¤´ -->
                    <text x="80" y="45" font-family="Noto Sans SC" font-weight="bold" font-size="36" fill="#009FE8">å®¶è¾‰åŸ¹ä¼˜</text>
                </svg>
                <h2 class="text-xl font-bold text-slate-700">æ•™å­¦ç£å¯¼ç³»ç»Ÿç™»å½•</h2>
            </div>
            <form onsubmit="event.preventDefault(); window.handleLogin(this.name.value, this.role.value);" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-600 mb-1">æ‚¨çš„å§“å</label>
                    <input type="text" name="name" required class="w-full border-2 border-slate-200 rounded-lg p-3 focus:border-jhblue outline-none transition" placeholder="è¯·è¾“å…¥çœŸå®å§“å">
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-600 mb-1">è§’è‰²é€‰æ‹©</label>
                    <select name="role" class="w-full border-2 border-slate-200 rounded-lg p-3 focus:border-jhblue outline-none bg-white">
                        <option value="supervisor">ç£å¯¼è€å¸ˆ</option>
                        <option value="admin">ç³»ç»Ÿç®¡ç†å‘˜ (éœ€æˆæƒ)</option>
                    </select>
                </div>
                <button type="submit" class="w-full bg-jhblue text-white font-bold py-3 rounded-lg hover:bg-sky-600 transition shadow-lg shadow-blue-200">
                    è¿›å…¥ç³»ç»Ÿ
                </button>
            </form>
            <p class="text-xs text-center text-slate-400 mt-4">åˆå§‹ç™»å½•å°†è‡ªåŠ¨åˆ›å»ºè´¦å·</p>
        </div>
    </div>

    <!-- App å®¹å™¨ -->
    <div id="app-container" class="flex w-full h-full hidden">
        <!-- ä¾§è¾¹æ  -->
        <aside id="sidebar" class="w-64 bg-white border-r border-slate-200 flex flex-col no-print z-20 hidden md:flex">
            <div class="p-6 border-b border-slate-100 flex items-center gap-3">
                <!-- SVG Logo Mini -->
                <svg class="w-8 h-8" viewBox="0 0 60 60" fill="none">
                    <path d="M30 5C15 5 5 15 5 30C5 45 15 55 30 55C45 55 55 45 55 30" stroke="#009FE8" stroke-width="6"/>
                    <circle cx="30" cy="30" r="8" fill="#009FE8"/>
                    <path d="M5 30L0 10L20 20" fill="#FF6B6B"/>
                </svg>
                <div>
                    <h1 class="text-lg font-bold text-jhblue tracking-wide">å®¶è¾‰åŸ¹ä¼˜</h1>
                    <p class="text-[10px] text-slate-400">Jiahui Education</p>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <a href="javascript:void(0)" onclick="switchPage('home')" id="nav-home" class="nav-item active flex items-center p-3 rounded-lg text-slate-600 hover:bg-slate-50 transition">
                    <i class="fas fa-chart-pie w-6 text-center"></i>
                    <span class="font-medium ml-2">ä»ªè¡¨ç›˜</span>
                </a>
                <a href="javascript:void(0)" onclick="switchPage('tool')" id="nav-tool" class="nav-item flex items-center p-3 rounded-lg text-slate-600 hover:bg-slate-50 transition">
                    <i class="fas fa-plus-circle w-6 text-center"></i>
                    <span class="font-medium ml-2">æ–°å»ºå¬è¯¾</span>
                </a>
                <a href="javascript:void(0)" onclick="switchPage('data')" id="nav-data" class="nav-item flex items-center p-3 rounded-lg text-slate-600 hover:bg-slate-50 transition">
                    <i class="fas fa-database w-6 text-center"></i>
                    <span class="font-medium ml-2">å¬è¯¾æ•°æ®åº“</span>
                </a>
                <!-- ç®¡ç†å‘˜å…¥å£ -->
                <a href="javascript:void(0)" onclick="switchPage('admin')" id="nav-admin" class="nav-item flex items-center p-3 rounded-lg text-slate-600 hover:bg-slate-50 transition hidden">
                    <i class="fas fa-users-cog w-6 text-center"></i>
                    <span class="font-medium ml-2">ç”¨æˆ·æƒé™ç®¡ç†</span>
                </a>
            </nav>
            
            <div class="p-4 border-t border-slate-100">
                <div class="bg-slate-50 rounded-lg p-3 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-jhblue text-white flex items-center justify-center font-bold text-xs">
                            <i class="fas fa-user"></i>
                        </div>
                        <div>
                            <div id="sidebar-username" class="text-sm font-bold text-slate-700">ç”¨æˆ·</div>
                            <div id="sidebar-role" class="text-xs text-slate-500">è§’è‰²</div>
                        </div>
                    </div>
                    <button onclick="handleLogout()" class="text-slate-400 hover:text-jhorange" title="é€€å‡ºç™»å½•">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </aside>

        <!-- ç§»åŠ¨ç«¯ Header -->
        <div class="md:hidden fixed top-0 left-0 right-0 bg-white border-b border-slate-200 p-4 z-30 flex justify-between items-center shadow-sm">
            <span class="text-jhblue font-bold">å®¶è¾‰åŸ¹ä¼˜ç£å¯¼</span>
            <div class="flex gap-4">
                <button onclick="switchPage('home')"><i class="fas fa-home text-slate-600"></i></button>
                <button onclick="switchPage('tool')"><i class="fas fa-plus-circle text-jhblue"></i></button>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒº -->
        <main id="main-content" class="flex-1 overflow-y-auto relative pt-16 md:pt-0">
            
            <!-- 1. ä»ªè¡¨ç›˜ -->
            <div id="home-view" class="p-8 max-w-6xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">ğŸ‘‹ <span id="welcome-msg">æ¬¢è¿å›æ¥</span></h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-jhblue">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-slate-500 text-sm">ç´¯è®¡å¬è¯¾</p>
                            <div class="bg-blue-50 p-2 rounded text-jhblue"><i class="fas fa-folder-open"></i></div>
                        </div>
                        <h3 id="stat-total" class="text-3xl font-bold text-slate-800">0</h3>
                        <p class="text-xs text-slate-400 mt-1">Total Records</p>
                    </div>
                    
                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-jhorange">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-slate-500 text-sm">æœ¬æœˆæ–°å¢</p>
                            <div class="bg-orange-50 p-2 rounded text-jhorange"><i class="fas fa-calendar-plus"></i></div>
                        </div>
                        <h3 id="stat-month" class="text-3xl font-bold text-slate-800">0</h3>
                        <p class="text-xs text-slate-400 mt-1">This Month</p>
                    </div>

                    <div class="bg-white p-6 rounded-xl shadow-sm border-l-4 border-purple-500">
                        <div class="flex justify-between items-start mb-2">
                            <p class="text-slate-500 text-sm">å¹³å‡å¾—åˆ†</p>
                            <div class="bg-purple-50 p-2 rounded text-purple-600"><i class="fas fa-chart-line"></i></div>
                        </div>
                        <h3 id="stat-avg" class="text-3xl font-bold text-slate-800">-</h3>
                        <p class="text-xs text-slate-400 mt-1">Average Score</p>
                    </div>
                </div>

                <!-- å¿«æ·å…¥å£ -->
                <div class="bg-gradient-to-r from-sky-500 to-jhblue rounded-xl p-8 text-white shadow-lg mb-8 relative overflow-hidden">
                    <div class="relative z-10">
                        <h3 class="text-xl font-bold mb-2">å‡†å¤‡å¼€å§‹æ–°çš„å¬è¯¾ï¼Ÿ</h3>
                        <p class="text-blue-100 text-sm mb-6 max-w-md">ä½¿ç”¨æœ€æ–°çš„äº”ç»´è¯„ä¼°æ¨¡å‹ï¼ˆæœ‰è¶£ã€æœ‰æ•ˆã€æœ‰ç”¨ã€æ„ŸçŸ¥ã€ç»“æœï¼‰è¿›è¡Œè®°å½•ã€‚ç³»ç»Ÿå°†è‡ªåŠ¨ç”Ÿæˆå¯è§†åŒ–é›·è¾¾å›¾æŠ¥å‘Šã€‚</p>
                        <button onclick="switchPage('tool')" class="bg-white text-jhblue px-6 py-2 rounded-lg font-bold hover:bg-blue-50 transition shadow">
                            <i class="fas fa-plus mr-2"></i> æ–°å»ºè¯„ä¼°è®°å½•
                        </button>
                    </div>
                    <!-- è£…é¥°èƒŒæ™¯ -->
                    <i class="fas fa-clipboard-check absolute -bottom-4 -right-4 text-9xl text-white opacity-10"></i>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">ğŸ“‹ æœ€è¿‘åŠ¨æ€</h3>
                    <div id="recent-activity" class="space-y-3">
                        <p class="text-sm text-slate-400 py-4 text-center">æš‚æ— åŠ¨æ€</p>
                    </div>
                </div>
            </div>

            <!-- 2. æ•°æ®åº“ -->
            <div id="data-view" class="hidden p-8 max-w-6xl mx-auto">
                <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-slate-800">å¬è¯¾æ•°æ®åº“</h2>
                    <div class="flex gap-2">
                        <button onclick="exportToCSV()" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 text-sm font-medium shadow flex items-center">
                            <i class="fas fa-file-excel mr-2"></i> å¯¼å‡ºæŠ¥è¡¨
                        </button>
                        <button onclick="window.loadEvaluations()" class="bg-white border border-slate-300 text-slate-600 px-4 py-2 rounded-lg hover:bg-slate-50 text-sm font-medium">
                            <i class="fas fa-sync-alt mr-2"></i> åˆ·æ–°
                        </button>
                    </div>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold border-b border-slate-200">
                                <tr>
                                    <th class="p-4">æ—¥æœŸ/ç±»å‹</th>
                                    <th class="p-4">ç£å¯¼</th>
                                    <th class="p-4">æ•™å¸ˆ</th>
                                    <th class="p-4">è¯¾é¢˜</th>
                                    <th class="p-4">æ€»åˆ†</th>
                                    <th class="p-4">è¯„çº§</th>
                                    <th class="p-4">æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="text-sm text-slate-700 divide-y divide-slate-100">
                                <!-- Data injected here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- 3. æ–°å»ºå¬è¯¾ (å·¥å…·) -->
            <div id="tool-view" class="hidden p-4 md:p-8 max-w-4xl mx-auto">
                <header class="mb-6 border-b pb-4">
                    <h1 class="text-2xl font-bold text-slate-800">æ–°å»ºè¯„ä¼°è®°å½•</h1>
                    <p class="text-slate-500 text-sm mt-1">è¯·åŸºäºâ€œæœ‰è¶£Â·æœ‰æ•ˆÂ·æœ‰ç”¨â€çš„æ ¸å¿ƒä»·å€¼è§‚è¿›è¡Œå®¢è§‚è¯„ä»·</p>
                </header>

                <form id="evaluation-form" class="space-y-6 pb-24">
                    <!-- åŸºç¡€ä¿¡æ¯ -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <h2 class="text-lg font-bold mb-4 border-l-4 border-jhblue pl-3 text-slate-700">åŸºç¡€ä¿¡æ¯</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="label-text">ç£å¯¼å§“å</label>
                                <input type="text" id="supervisorName" class="input-field" readonly>
                            </div>
                            <div>
                                <label class="label-text">å¬è¯¾æ—¥æœŸ</label>
                                <input type="date" id="date" class="input-field">
                            </div>
                            <div>
                                <label class="label-text">æ•™å¸ˆå§“å</label>
                                <input type="text" id="teacherName" class="input-field" placeholder="æˆè¯¾æ•™å¸ˆ">
                            </div>
                            <div>
                                <label class="label-text">è¯¾ç¨‹ç±»å‹</label>
                                <select id="courseType" class="input-field bg-white">
                                    <option value="å¸¸è§„è¯¾">å¸¸è§„è¯¾</option>
                                    <option value="åˆ†ç»„è¯¾">åˆ†ç»„è¯¾</option>
                                    <option value="è¯•å¬è¯¾">è¯•å¬è¯¾</option>
                                </select>
                            </div>
                            <div class="md:col-span-2">
                                <label class="label-text">è¯¾ç¨‹/ç­çº§/è¯¾é¢˜</label>
                                <input type="text" id="topic" class="input-field" placeholder="ä¾‹å¦‚ï¼šåˆäºŒæ•°å­¦ - å¹³é¢å‡ ä½•è¾…åŠ©çº¿">
                            </div>
                        </div>
                    </div>

                    <!-- è¯„åˆ†æ¨¡å— -->
                    <div class="space-y-4">
                        <!-- Fun -->
                        <div class="score-card border-l-4 border-purple-400">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-bold text-purple-700 text-lg">1. æœ‰è¶£å‘³ (Interest)</label>
                                <input type="number" id="scoreFun" max="20" min="0" class="score-input" placeholder="0-20">
                            </div>
                            <div class="text-xs text-slate-400 mb-2 italic">ğŸ“Œ å…³æ³¨ç‚¹ï¼šå¯¼å…¥æ˜¯å¦å¸å¼•äººï¼Ÿäº’åŠ¨æ˜¯å¦æœ‰æ•ˆï¼Ÿè¯¾å ‚æ°›å›´æ˜¯å¦æ´»è·ƒï¼Ÿ</div>
                            <div id="tags-fun" class="flex gap-2 text-xs mb-3 flex-wrap">
                                <span class="check-item" onclick="toggleCheck(this)">å¯¼å…¥æŠ“äºº</span>
                                <span class="check-item" onclick="toggleCheck(this)">æ‹’ç»ä¸€è¨€å ‚</span>
                                <span class="check-item" onclick="toggleCheck(this)">æ°›å›´æ´»è·ƒ</span>
                                <span class="check-item" onclick="toggleCheck(this)">æ¸¸æˆåŒ–æ•™å­¦</span>
                            </div>
                            <textarea id="textFun" class="textarea-field" placeholder="å…·ä½“çš„ä¼˜ç‚¹æˆ–ä¸è¶³..."></textarea>
                        </div>

                        <!-- Efficiency -->
                        <div class="score-card border-l-4 border-blue-400">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-bold text-blue-700 text-lg">2. æœ‰æ•ˆç‡ (Efficiency)</label>
                                <input type="number" id="scoreEff" max="20" min="0" class="score-input text-blue-700 border-blue-200" placeholder="0-20">
                            </div>
                            <div class="text-xs text-slate-400 mb-2 italic">ğŸ“Œ å…³æ³¨ç‚¹ï¼šç¯èŠ‚è¿‡æ¸¡æ˜¯å¦è‡ªç„¶ï¼ŸæŒ‡ä»¤æ˜¯å¦æ¸…æ™°ï¼Ÿæœ‰æ— æ— æ•ˆæ—¶é—´ï¼Ÿ</div>
                            <div id="tags-eff" class="flex gap-2 text-xs mb-3 flex-wrap">
                                <span class="check-item" onclick="toggleCheck(this)">æ— æ— æ•ˆæ—¶é—´</span>
                                <span class="check-item" onclick="toggleCheck(this)">æŒ‡ä»¤æ¸…æ™°</span>
                                <span class="check-item" onclick="toggleCheck(this)">èŠ‚å¥ç´§å‡‘</span>
                            </div>
                            <textarea id="textEff" class="textarea-field" placeholder="å…·ä½“çš„ä¼˜ç‚¹æˆ–ä¸è¶³..."></textarea>
                        </div>

                        <!-- Utility -->
                        <div class="score-card border-l-4 border-green-400">
                            <div class="flex justify-between items-center mb-2">
                                <label class="font-bold text-green-700 text-lg">3. æœ‰ç”¨å¤„ (Utility)</label>
                                <input type="number" id="scoreUse" max="20" min="0" class="score-input text-green-700 border-green-200" placeholder="0-20">
                            </div>
                            <div class="text-xs text-slate-400 mb-2 italic">ğŸ“Œ å…³æ³¨ç‚¹ï¼šè€ƒç‚¹æ˜¯å¦èšç„¦ï¼Ÿæ–¹æ³•æ˜¯å¦è½åœ°ï¼Ÿæ˜¯å¦æœ‰æ€»ç»“æ¸…å•ï¼Ÿ</div>
                            <div id="tags-use" class="flex gap-2 text-xs mb-3 flex-wrap">
                                <span class="check-item" onclick="toggleCheck(this)">è€ƒç‚¹èšç„¦</span>
                                <span class="check-item" onclick="toggleCheck(this)">æ–¹æ³•å…·ä½“</span>
                                <span class="check-item" onclick="toggleCheck(this)">æœ‰æ€»ç»“æ¸…å•</span>
                            </div>
                            <textarea id="textUse" class="textarea-field" placeholder="å…·ä½“çš„ä¼˜ç‚¹æˆ–ä¸è¶³..."></textarea>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Awareness -->
                            <div class="score-card border-l-4 border-orange-300">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="font-bold text-orange-700">4. æ„ŸçŸ¥åŠ›</label>
                                    <select id="scoreAwareness" class="score-select text-orange-700 border-orange-200">
                                        <option value="0">-</option><option value="20">20(ä¼˜)</option><option value="16">16(è‰¯)</option><option value="12">12(ä¸­)</option><option value="8">8(å·®)</option>
                                    </select>
                                </div>
                                <div class="text-[10px] text-slate-400 mb-2 italic">ğŸ“Œ å…³æ³¨ç‚¹ï¼šå…³æ³¨åæ’/èµ°ç¥å­¦ç”Ÿï¼Ÿæ ¹æ®åé¦ˆè°ƒæ•´èŠ‚å¥ï¼Ÿ</div>
                                <textarea id="textAwareness" class="textarea-field" placeholder="è¯„ä»·..."></textarea>
                            </div>
                            <!-- Result -->
                            <div class="score-card border-l-4 border-red-300">
                                <div class="flex justify-between items-center mb-2">
                                    <label class="font-bold text-red-700">5. ç»“æœéªŒæ”¶</label>
                                    <select id="scoreResult" class="score-select text-red-700 border-red-200">
                                        <option value="0">-</option><option value="20">20(ä¼˜)</option><option value="16">16(è‰¯)</option><option value="12">12(ä¸­)</option><option value="8">8(å·®)</option>
                                    </select>
                                </div>
                                <div class="text-[10px] text-slate-400 mb-2 italic">ğŸ“Œ å…³æ³¨ç‚¹ï¼šå…¨ç­æ­£ç¡®ç‡ï¼ŸäºŒæ¬¡æ ¸æŸ¥ï¼Ÿå½“å ‚çº é”™ï¼Ÿ</div>
                                <textarea id="textResult" class="textarea-field" placeholder="è¯„ä»·..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- ç»“è®º -->
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                        <div class="mb-4">
                            <label class="label-text mb-2">ğŸ’¡ æ€»ä½“æ”¹è¿›å»ºè®®</label>
                            <textarea id="textOverallImprovement" class="textarea-field h-24" placeholder="è¯·ç»™å‡º1-3æ¡æ ¸å¿ƒå»ºè®®"></textarea>
                        </div>
                        <div>
                            <label class="label-text mb-2">ğŸ æœ€ç»ˆå¬è¯¾ç»“è®º</label>
                            <textarea id="textFinalVerdict" class="textarea-field h-24" placeholder="ç»¼åˆè¯„ä»·..."></textarea>
                        </div>
                    </div>

                    <!-- åº•éƒ¨ä¿å­˜ -->
                    <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur border-t border-slate-200 flex justify-center z-40 md:static md:bg-transparent md:border-0 md:p-0">
                        <button type="button" onclick="handleGenerateAndSave()" class="w-full max-w-md bg-jhblue text-white font-bold py-3 rounded-xl shadow-lg shadow-blue-200 hover:bg-sky-600 transition transform hover:-translate-y-1">
                            <i class="fas fa-save mr-2"></i> ç”Ÿæˆè¯„ä¼°æŠ¥å‘Š
                        </button>
                    </div>
                </form>
            </div>

            <!-- 4. ç®¡ç†å‘˜é¢æ¿ -->
            <div id="admin-view" class="hidden p-8 max-w-6xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6">ç”¨æˆ·æƒé™ç®¡ç†</h2>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left">
                        <thead class="bg-slate-50 text-slate-500 text-xs uppercase font-bold">
                            <tr>
                                <th class="p-4">å§“å</th>
                                <th class="p-4">è§’è‰²</th>
                                <th class="p-4">æ³¨å†Œæ—¶é—´</th>
                                <th class="p-4">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="user-table-body">
                            <!-- Users injected here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- 5. æŠ¥å‘Šé¢„è§ˆ Modal -->
            <div id="report-view" class="hidden fixed inset-0 z-50 overflow-y-auto bg-slate-800/95 backdrop-blur-sm">
                <div id="report-container" class="relative w-full max-w-[800px] mx-auto my-0 md:my-8 bg-white shadow-2xl overflow-hidden print:shadow-none print:m-0 min-h-screen md:min-h-fit md:rounded-lg">
                    <!-- æŠ¥å‘Šå¤´éƒ¨ -->
                    <div class="bg-gradient-to-r from-sky-500 to-jhblue text-white p-8 relative overflow-hidden">
                        <div class="relative z-10 flex justify-between items-start">
                            <div>
                                <div class="text-xs opacity-80 uppercase tracking-widest mb-1">Teaching Quality Assessment</div>
                                <h1 class="text-3xl font-bold flex items-center gap-3">
                                    <svg class="w-8 h-8 bg-white rounded-full p-1" viewBox="0 0 60 60" fill="none">
                                        <path d="M30 5C15 5 5 15 5 30C5 45 15 55 30 55C45 55 55 45 55 30" stroke="#009FE8" stroke-width="6"/>
                                        <circle cx="30" cy="30" r="8" fill="#009FE8"/>
                                        <path d="M5 30L0 10L20 20" fill="#FF6B6B"/>
                                    </svg>
                                    å®¶è¾‰åŸ¹ä¼˜ Â· ç£å¯¼åé¦ˆ
                                </h1>
                            </div>
                            <div class="text-right">
                                <div id="displayLevel" class="text-5xl font-bold text-yellow-300 drop-shadow-md">A</div>
                                <div class="text-xs uppercase mt-1 opacity-80">Rating Level</div>
                            </div>
                        </div>
                        <div class="mt-6 flex flex-wrap gap-x-6 gap-y-2 text-sm opacity-90 border-t border-white/20 pt-4">
                            <span class="bg-white/20 px-2 py-1 rounded"><i class="fas fa-user-tie mr-1"></i>ç£å¯¼: <span id="displaySupervisor"></span></span>
                            <span class="bg-white/20 px-2 py-1 rounded"><i class="fas fa-chalkboard-teacher mr-1"></i><span id="displayTeacher"></span></span>
                            <span class="bg-white/20 px-2 py-1 rounded"><i class="fas fa-layer-group mr-1"></i><span id="displayCourseType"></span></span>
                            <span class="bg-white/20 px-2 py-1 rounded"><i class="fas fa-book mr-1"></i><span id="displayTopic"></span></span>
                            <span class="ml-auto"><span id="displayDate"></span></span>
                        </div>
                    </div>

                    <!-- æŠ¥å‘Šä¸»ä½“ -->
                    <div class="p-8 pb-32">
                        <!-- 1. é›·è¾¾å›¾ -->
                        <div class="mb-8 flex flex-col items-center">
                            <div class="w-full max-w-[400px] h-[300px]">
                                <canvas id="radarChart"></canvas>
                            </div>
                            <div class="mt-4 bg-slate-50 px-6 py-3 rounded-full border border-slate-200">
                                <span class="text-slate-500 font-bold uppercase mr-2 text-xs">Total Score</span>
                                <span id="displayTotalScore" class="text-3xl font-black text-jhblue">85</span>
                                <span class="text-slate-400 text-sm">/ 100</span>
                            </div>
                        </div>

                        <!-- 2. ç»´åº¦è¯¦æƒ… -->
                        <div class="mb-8">
                            <h3 class="flex items-center text-slate-800 font-bold text-lg mb-4">
                                <span class="bg-jhblue text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">2</span>
                                ç»´åº¦è¯„ä»·è¯¦æƒ…
                            </h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- Cards injected here by JS -->
                                <div class="detail-card bg-purple-50 border-purple-100">
                                    <div class="card-header text-purple-700">æœ‰è¶£å‘³ (Fun) <span id="tag-fun" class="tag-pill bg-purple-100"></span></div>
                                    <p id="feedFunDisplay" class="text-sm text-slate-600 mt-2"></p>
                                </div>
                                <div class="detail-card bg-blue-50 border-blue-100">
                                    <div class="card-header text-blue-700">æœ‰æ•ˆç‡ (Eff) <span id="tag-eff" class="tag-pill bg-blue-100"></span></div>
                                    <p id="feedEffDisplay" class="text-sm text-slate-600 mt-2"></p>
                                </div>
                                <div class="detail-card bg-green-50 border-green-100">
                                    <div class="card-header text-green-700">æœ‰ç”¨å¤„ (Use) <span id="tag-use" class="tag-pill bg-green-100"></span></div>
                                    <p id="feedUseDisplay" class="text-sm text-slate-600 mt-2"></p>
                                </div>
                                <div class="detail-card bg-orange-50 border-orange-100">
                                    <div class="card-header text-orange-700">æ„ŸçŸ¥åŠ› (Awareness)</div>
                                    <p id="feedAwarenessDisplayReport" class="text-sm text-slate-600 mt-2"></p>
                                </div>
                                <div class="detail-card bg-red-50 border-red-100 md:col-span-2">
                                    <div class="card-header text-red-700">ç»“æœéªŒæ”¶ (Result)</div>
                                    <p id="feedResultDisplayReport" class="text-sm text-slate-600 mt-2"></p>
                                </div>
                            </div>
                        </div>

                        <!-- 3. ç»“è®º -->
                        <div>
                            <h3 class="flex items-center text-slate-800 font-bold text-lg mb-4">
                                <span class="bg-jhblue text-white w-6 h-6 rounded-full flex items-center justify-center text-xs mr-2">3</span>
                                æ”¹è¿›ä¸ç»“è®º
                            </h3>
                            <div class="bg-white border-l-4 border-jhorange p-4 shadow-sm mb-4">
                                <div class="text-xs font-bold text-jhorange uppercase mb-1">Suggestions</div>
                                <p id="displayOverallImprovementReport" class="text-slate-700 text-sm whitespace-pre-line"></p>
                            </div>
                            <div class="bg-slate-800 text-white p-5 rounded-r-lg border-l-4 border-jhblue shadow-lg">
                                <div class="text-xs font-bold text-slate-400 uppercase mb-1">Final Verdict</div>
                                <p id="displayFinalVerdictReport" class="text-base font-light italic leading-relaxed"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- æµ®åŠ¨æ“ä½œæ  -->
                <div class="fixed bottom-0 left-0 right-0 p-4 bg-white/90 backdrop-blur flex justify-center gap-4 border-t z-50 no-print">
                    <button onclick="closeReport()" class="btn-secondary"><i class="fas fa-times mr-2"></i>å…³é—­</button>
                    <button onclick="saveReportAsImage()" class="btn-primary"><i class="fas fa-image mr-2"></i>ä¿å­˜å›¾ç‰‡ (é«˜æ¸…)</button>
                </div>
            </div>

        </main>
    </div>

    <!-- CSS Helpers -->
    <style>
        .input-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.5rem; font-size: 0.875rem; transition: all 0.2s; }
        .input-field:focus { border-color: #009FE8; outline: none; box-shadow: 0 0 0 3px rgba(0, 159, 232, 0.1); }
        .label-text { display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 0.25rem; }
        .score-card { background: white; padding: 1rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; }
        .score-input { width: 4rem; text-align: center; border: 2px solid #e9d5ff; border-radius: 0.5rem; padding: 0.25rem; font-weight: bold; color: #7e22ce; outline: none; }
        .score-select { border: 2px solid #fdba74; border-radius: 0.5rem; padding: 0.25rem; font-weight: bold; outline: none; font-size: 0.875rem; }
        .check-item { display: inline-block; padding: 0.25rem 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.25rem; background: #f8fafc; color: #64748b; }
        .textarea-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.5rem; font-size: 0.875rem; height: 4rem; outline: none; focus:border-jhblue; }
        .textarea-field:focus { border-color: #009FE8; }
        .btn-primary { background: #009FE8; color: white; padding: 0.5rem 1.5rem; border-radius: 0.5rem; font-weight: bold; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 159, 232, 0.3); }
        .btn-primary:hover { background: #0284c7; transform: translateY(-1px); }
        .btn-secondary { background: white; color: #475569; border: 1px solid #cbd5e1; padding: 0.5rem 1.5rem; border-radius: 0.5rem; font-weight: bold; transition: all 0.2s; }
        .btn-secondary:hover { background: #f1f5f9; }
        
        .detail-card { padding: 1rem; border-radius: 0.5rem; border-width: 1px; }
        .card-header { font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; }
        .tag-pill { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; border: 1px solid currentColor; opacity: 0.8; }
    </style>

    <script>
        // è®¾ç½®é»˜è®¤æ—¥æœŸ
        try { document.getElementById('date').valueAsDate = new Date(); } catch(e) {}
        let myChart = null;

        // UI è¾…åŠ©
        function toggleCheck(el) { el.classList.toggle('checked'); }
        function showToast(msg) {
            const t = document.getElementById('toast-container');
            document.getElementById('toast-message').innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }
        function getSelectedTags(id) {
            const container = document.getElementById(id);
            return container ? Array.from(container.querySelectorAll('.check-item.checked')).map(e => e.innerText) : [];
        }

        // é¡µé¢åˆ‡æ¢
        window.switchPage = (pageId) => {
            if (pageId === 'admin' && appUser.role !== 'admin') {
                alert("æ— æƒé™è®¿é—®");
                return;
            }
            ['home-view', 'tool-view', 'data-view', 'admin-view'].forEach(id => document.getElementById(id).classList.add('hidden'));
            document.getElementById('report-view').classList.add('hidden');
            
            document.getElementById(pageId + '-view').classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navBtn = document.getElementById('nav-' + pageId);
            if(navBtn) navBtn.classList.add('active');

            if (pageId === 'admin') window.loadAllUsers();
        }

        // æ•°æ®æ”¶é›†
        window.handleGenerateAndSave = () => {
            const getVal = (id) => parseInt(document.getElementById(id).value) || 0;
            const getText = (id) => document.getElementById(id).value;
            
            const scores = [getVal('scoreFun'), getVal('scoreEff'), getVal('scoreUse'), getVal('scoreAwareness'), getVal('scoreResult')];
            const total = scores.reduce((a,b) => a+b, 0);
            
            let level = "C éœ€æ”¹è¿›";
            if (total >= 90) level = "A+ å“è¶Š";
            else if (total >= 85) level = "A é«˜æ•ˆ";
            else if (total >= 75) level = "B åˆæ ¼";

            const data = {
                supervisorName: getText('supervisorName'),
                teacherName: getText('teacherName'),
                courseType: document.getElementById('courseType').value,
                topic: getText('topic'),
                date: getText('date'),
                scores: scores,
                totalScore: total,
                level: level,
                tags: {
                    fun: getSelectedTags('tags-fun'),
                    eff: getSelectedTags('tags-eff'),
                    use: getSelectedTags('tags-use')
                },
                feedbacks: {
                    fun: getText('textFun'),
                    eff: getText('textEff'),
                    use: getText('textUse'),
                    awareness: getText('textAwareness'),
                    result: getText('textResult'),
                    overall: getText('textOverallImprovement'),
                    verdict: getText('textFinalVerdict')
                }
            };

            window.saveEvaluationToDB(data);
            window.renderReport(data);
        }

        // æ¸²æŸ“æŠ¥å‘Š
        window.renderReport = (data) => {
            document.getElementById('displaySupervisor').innerText = data.supervisorName;
            document.getElementById('displayTeacher').innerText = data.teacherName;
            document.getElementById('displayCourseType').innerText = data.courseType;
            document.getElementById('displayTopic').innerText = data.topic;
            document.getElementById('displayDate').innerText = data.date;
            document.getElementById('displayTotalScore').innerText = data.totalScore;
            document.getElementById('displayLevel').innerText = data.level.split(' ')[0];

            // å¡«å……åˆ†æ•°å’Œæ–‡æœ¬
            const mapFeed = (id, text) => document.getElementById(id).innerText = text || "æš‚æ— è¯„ä»·";
            mapFeed('feedFunDisplay', data.feedbacks.fun);
            mapFeed('feedEffDisplay', data.feedbacks.eff);
            mapFeed('feedUseDisplay', data.feedbacks.use);
            mapFeed('feedAwarenessDisplayReport', data.feedbacks.awareness);
            mapFeed('feedResultDisplayReport', data.feedbacks.result);
            mapFeed('displayOverallImprovementReport', data.feedbacks.overall);
            mapFeed('displayFinalVerdictReport', data.feedbacks.verdict);

            // å¡«å……æ ‡ç­¾
            const mapTags = (id, tags) => document.getElementById(id).innerText = (tags || []).join(' / ');
            mapTags('tag-fun', data.tags.fun);
            mapTags('tag-eff', data.tags.eff);
            mapTags('tag-use', data.tags.use);

            document.getElementById('report-view').classList.remove('hidden');

            // æ¸²æŸ“å›¾è¡¨
            setTimeout(() => {
                const ctx = document.getElementById('radarChart').getContext('2d');
                if (myChart) myChart.destroy();
                myChart = new Chart(ctx, {
                    type: 'radar',
                    data: {
                        labels: ['æœ‰è¶£', 'æœ‰æ•ˆ', 'æœ‰ç”¨', 'æ„ŸçŸ¥', 'ç»“æœ'],
                        datasets: [{
                            label: 'å¾—åˆ†',
                            data: data.scores,
                            fill: true,
                            backgroundColor: 'rgba(0, 159, 232, 0.2)', // jhblue with opacity
                            borderColor: '#009FE8',
                            pointBackgroundColor: '#FF6B6B', // jhorange points
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: '#FF6B6B'
                        }]
                    },
                    options: {
                        scales: { r: { suggestedMin: 0, suggestedMax: 20, ticks: { display: false } } },
                        plugins: { legend: { display: false } },
                        maintainAspectRatio: false
                    }
                });
            }, 100);
        }

        window.closeReport = () => {
            document.getElementById('report-view').classList.add('hidden');
            window.switchPage('tool');
        }

        // æ¸²æŸ“è¡¨æ ¼ (å…¨å±€)
        window.renderTableGlobal = (evaluations) => {
            const tbody = document.getElementById('data-table-body');
            tbody.innerHTML = evaluations.length ? '' : '<tr><td colspan="7" class="p-8 text-center text-slate-400">æš‚æ— æ•°æ®</td></tr>';
            
            evaluations.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-slate-50 transition";
                let badgeClass = "bg-gray-100 text-gray-700";
                if (item.level.includes("A")) badgeClass = "bg-green-100 text-green-700";
                else if (item.level.includes("B")) badgeClass = "bg-blue-100 text-blue-700";
                else if (item.level.includes("C")) badgeClass = "bg-red-100 text-red-700";

                tr.innerHTML = `
                    <td class="p-4">
                        <div class="font-bold text-slate-700">${item.date}</div>
                        <div class="text-xs text-slate-400 mt-1">${item.courseType || 'å¸¸è§„è¯¾'}</div>
                    </td>
                    <td class="p-4 text-slate-600 text-sm">${item.supervisorName || '-'}</td>
                    <td class="p-4 font-medium">${item.teacherName}</td>
                    <td class="p-4 text-slate-500 text-sm max-w-xs truncate">${item.topic}</td>
                    <td class="p-4 font-bold text-jhblue">${item.totalScore}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${item.level.split(' ')[0]}</span></td>
                    <td class="p-4">
                        <button onclick="window.viewRecordGlobal('${item.id}')" class="text-jhblue hover:underline text-sm font-medium">æŸ¥çœ‹</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // å…¨å±€ Dashboard æ›´æ–°
        window.updateDashboardGlobal = (evaluations) => {
            document.getElementById('stat-total').innerText = evaluations.length;
            
            // è®¡ç®—æœ¬æœˆ
            const now = new Date();
            const thisMonth = evaluations.filter(e => {
                const d = new Date(e.timestamp);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            }).length;
            document.getElementById('stat-month').innerText = thisMonth;

            // è®¡ç®—å‡åˆ†
            if (evaluations.length > 0) {
                const total = evaluations.reduce((sum, e) => sum + (e.totalScore || 0), 0);
                document.getElementById('stat-avg').innerText = (total / evaluations.length).toFixed(1);
            }

            // æœ€è¿‘åŠ¨æ€
            const activityList = document.getElementById('recent-activity');
            activityList.innerHTML = '';
            if(evaluations.length === 0) activityList.innerHTML = '<p class="text-sm text-slate-400 py-4 text-center">æš‚æ— åŠ¨æ€</p>';
            
            evaluations.slice(0, 3).forEach(item => {
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition cursor-pointer";
                div.onclick = () => window.viewRecordGlobal(item.id);
                div.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="w-2 h-2 rounded-full bg-jhblue"></div>
                        <div>
                            <div class="font-bold text-sm text-slate-700">${item.teacherName} <span class="font-normal text-xs text-slate-400">(${item.courseType})</span></div>
                            <div class="text-xs text-slate-500">${item.date} Â· ${item.supervisorName}</div>
                        </div>
                    </div>
                    <div class="font-bold text-jhblue">${item.totalScore}åˆ†</div>
                `;
                activityList.appendChild(div);
            });
        }

        window.viewRecordGlobal = (id) => {
            const record = window.cachedEvaluations.find(e => e.id === id);
            if(record) window.renderReport(record);
        }

        // å¯¼å‡º CSV
        window.exportToCSV = () => {
            if (!window.cachedEvaluations || !window.cachedEvaluations.length) return alert("æ— æ•°æ®");
            let csv = "\ufeffæ—¥æœŸ,è¯¾ç¨‹ç±»å‹,ç£å¯¼,æ•™å¸ˆ,è¯¾é¢˜,æ€»åˆ†,è¯„çº§,å»ºè®®\n";
            window.cachedEvaluations.forEach(e => {
                const safe = (t) => `"${(t||'').toString().replace(/"/g,'""')}"`;
                csv += `${safe(e.date)},${safe(e.courseType)},${safe(e.supervisorName)},${safe(e.teacherName)},${safe(e.topic)},${e.totalScore},${safe(e.level)},${safe(e.feedbacks.overall)}\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `å®¶è¾‰åŸ¹ä¼˜_ç£å¯¼è®°å½•_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        // ç»ˆææˆªå›¾ä¿®å¤ç‰ˆ (Clone + Scale)
        window.saveReportAsImage = async () => {
            const original = document.getElementById('report-container');
            const overlay = document.getElementById('loading-overlay');
            overlay.style.display = 'flex';
            
            try {
                // 1. Clone DOM
                const clone = original.cloneNode(true);
                
                // 2. Fix Canvas
                const origCanvas = original.querySelector('canvas');
                const cloneCanvas = clone.querySelector('canvas');
                if (origCanvas && cloneCanvas) {
                    const img = document.createElement('img');
                    img.src = origCanvas.toDataURL();
                    img.style.width = '100%';
                    cloneCanvas.parentNode.replaceChild(img, cloneCanvas);
                }

                // 3. Style Clone (Off-screen render)
                clone.style.position = 'fixed';
                clone.style.top = '0';
                clone.style.left = '-9999px';
                clone.style.width = '800px'; // Fixed A4-like width
                clone.style.height = 'auto';
                clone.style.zIndex = '-1';
                clone.style.background = 'white';
                clone.style.borderRadius = '0';
                
                document.body.appendChild(clone);

                // 4. Capture
                const canvas = await html2canvas(clone, {
                    scale: 2,
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    windowWidth: 800
                });

                // 5. Save
                const link = document.createElement('a');
                link.download = `ç£å¯¼åé¦ˆ_${document.getElementById('displayTeacher').innerText}.png`;
                link.href = canvas.toDataURL();
                link.click();

                document.body.removeChild(clone);
            } catch (e) {
                console.error(e);
                alert("ç”Ÿæˆå›¾ç‰‡å¤±è´¥ï¼Œè¯·æˆªå›¾ä¿å­˜");
            } finally {
                overlay.style.display = 'none';
            }
        }
    </script>
</body>
</html>
