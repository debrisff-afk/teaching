<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>家辉培优 - 教学督导管理系统</title>
    
    <!-- 第三方库 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <!-- Tailwind 自定义配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        jhblue: '#009FE8', // 家辉蓝
                        jhorange: '#FF6B6B', // 活力橙
                    }
                }
            }
        }
    </script>

    <!-- 样式 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; background-color: #f0f9ff; }
        
        .nav-item.active { background-color: #e0f2fe; color: #009FE8; border-right: 4px solid #009FE8; }
        .score-input:focus { ring: 2px; ring-color: #009FE8; }
        .check-item { cursor: pointer; user-select: none; transition: all 0.2s; }
        .check-item.checked { color: #009FE8; font-weight: bold; background-color: #e0f2fe; border-color: #009FE8; }
        
        #toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; transform: translateX(120%); transition: transform 0.3s; }
        #toast-container.show { transform: translateX(0); }
        
        /* 启动加载页 */
        #system-loading { position: fixed; inset: 0; z-index: 99999; background: #fff; display: flex; align-items: center; justify-content: center; flex-direction: column; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.9); z-index: 100; display: none; align-items: center; justify-content: center; flex-direction: column; }
        
        .report-clone-container { background-color: white !important; -webkit-font-smoothing: antialiased; }
        
        @media print {
            .no-print { display: none !important; }
            #sidebar { display: none !important; }
            #report-view { display: block !important; position: static !important; overflow: visible !important; }
            #input-view, #home-view, #data-view, #tool-view, #admin-view { display: none !important; }
            body { background-color: white; overflow: visible !important; }
        }
        /* CSS 辅助类 */
        .input-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.5rem; font-size: 0.875rem; transition: all 0.2s; }
        .input-field:focus { border-color: #009FE8; outline: none; box-shadow: 0 0 0 3px rgba(0, 159, 232, 0.1); }
        .label-text { display: block; font-size: 0.875rem; font-weight: 600; color: #475569; margin-bottom: 0.25rem; }
        .score-card { background: white; padding: 1rem; border-radius: 0.75rem; border: 1px solid #e2e8f0; }
        .score-input { width: 4rem; text-align: center; border: 2px solid #e9d5ff; border-radius: 0.5rem; padding: 0.25rem; font-weight: bold; color: #7e22ce; outline: none; }
        .score-select { border: 2px solid #fdba74; border-radius: 0.5rem; padding: 0.25rem; font-weight: bold; outline: none; font-size: 0.875rem; }
        .check-item { display: inline-block; padding: 0.25rem 0.5rem; border: 1px solid #e2e8f0; border-radius: 0.25rem; background: #f8fafc; color: #64748b; }
        .textarea-field { width: 100%; border: 1px solid #cbd5e1; border-radius: 0.5rem; padding: 0.5rem; font-size: 0.875rem; height: 4rem; outline: none; focus:border-jhblue; }
        .textarea-field:focus { border-color: #009FE8; }
        .btn-primary { background: #009FE8; color: white; padding: 0.5rem 1.5rem; border-radius: 0.5rem; font-weight: bold; transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(0, 159, 232, 0.3); }
        .btn-primary:hover { background: #0284c7; transform: translateY(-1px); }
        .btn-secondary { background: white; color: #475569; border: 1px solid #cbd5e1; padding: 0.5rem 1.5rem; border-radius: 0.5rem; font-weight: bold; transition: all 0.2s; }
        .btn-secondary:hover { background: #f1f5f9; }
        .detail-card { padding: 1rem; border-radius: 0.5rem; border-width: 1px; }
        .card-header { font-weight: bold; display: flex; justify-content: space-between; align-items: center; font-size: 0.875rem; }
        .tag-pill { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; border: 1px solid currentColor; opacity: 0.8; }
    </style>

    <!-- 逻辑脚本 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, setDoc, doc, updateDoc, deleteDoc, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ================= 全局状态管理 =================
        let isLocalMode = false;
        let db = null;
        let auth = null;
        let firebaseUser = null; 
        let appUser = null;      
        let appId = 'default-app-id';
        let myChart = null; // 图表实例

        // ================= 初始化函数 =================
        async function initSystem() {
            console.log("System initializing...");
            
            // 启动看门狗：3秒后如果还没加载成功，强制显示登录页
            setTimeout(() => {
                const loading = document.getElementById('system-loading');
                if (loading && !loading.classList.contains('hidden')) {
                    console.warn("Init timeout, forcing local mode UI");
                    isLocalMode = true; // 强制标记为本地模式
                    checkLocalLogin();  // 尝试显示登录页
                }
            }, 3000);

            // 初始化日期
            const dateInput = document.getElementById('date');
            if (dateInput) { try { dateInput.valueAsDate = new Date(); } catch(e) {} }

            // 检查环境配置
            if (typeof __firebase_config === 'undefined' || !__firebase_config) {
                console.warn("⚠️ 本地模式 (No Config)");
                isLocalMode = true;
                checkLocalLogin();
                return;
            }

            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        firebaseUser = user;
                        const savedUid = localStorage.getItem('jh_session_uid');
                        if (savedUid) await loginWithUid(savedUid);
                        else showLoginModal();
                    } else {
                        showLoginModal();
                    }
                });

            } catch (e) {
                console.error("Firebase Init Error:", e);
                isLocalMode = true;
                checkLocalLogin();
            }
        }

        // ================= 账户与权限逻辑 =================

        function checkLocalLogin() {
            const savedUser = localStorage.getItem('jh_current_user');
            if (savedUser) {
                try {
                    appUser = JSON.parse(savedUser);
                    showApp();
                } catch(e) {
                    showLoginModal();
                }
            } else {
                showLoginModal();
            }
        }

        // 挂载到 Window 以供 HTML 调用
        window.handleLogin = async (username, password) => {
            const loadingBtn = document.getElementById('login-btn');
            if(loadingBtn) loadingBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> 登录中...';
            
            try {
                // 超级管理员后门
                if (username === 'admin' && password === '123456') {
                    appUser = { uid: 'admin_master', username: 'admin', name: '系统管理员', role: 'admin' };
                    finishLogin(appUser);
                    return;
                }

                if (isLocalMode) {
                    let localUsers = JSON.parse(localStorage.getItem('jh_users_db') || '[]');
                    const user = localUsers.find(u => u.username === username && u.password === password);
                    if (user) finishLogin(user);
                    else { alert("账号或密码错误"); resetLoginBtn(); }
                } else {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'jh_users');
                    const q = query(usersRef, where("username", "==", username));
                    const snapshot = await getDocs(q);
                    let foundUser = null;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.password === password) foundUser = { ...data, id: doc.id };
                    });

                    if (foundUser) finishLogin(foundUser);
                    else { alert("账号或密码错误"); resetLoginBtn(); }
                }
            } catch (e) {
                console.error(e);
                alert("登录出错: " + e.message);
                resetLoginBtn();
            }
        };

        function resetLoginBtn() {
            const btn = document.getElementById('login-btn');
            if(btn) btn.innerHTML = '登录系统';
        }

        function finishLogin(user) {
            appUser = user;
            if (isLocalMode) localStorage.setItem('jh_current_user', JSON.stringify(user));
            else localStorage.setItem('jh_session_uid', user.uid);
            showApp();
        }

        async function loginWithUid(uid) {
            if (uid === 'admin_master') {
                appUser = { uid: 'admin_master', username: 'admin', name: '系统管理员', role: 'admin' };
                showApp();
                return;
            }
            try {
                const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'jh_users');
                const q = query(usersRef, where("uid", "==", uid));
                const snapshot = await getDocs(q);
                let found = null;
                snapshot.forEach(doc => found = { ...doc.data(), id: doc.id });
                if (found) { appUser = found; showApp(); } else showLoginModal();
            } catch(e) { 
                console.error("Auto login failed", e);
                showLoginModal(); 
            }
        }

        window.handleLogout = () => {
            appUser = null;
            if (isLocalMode) localStorage.removeItem('jh_current_user');
            localStorage.removeItem('jh_session_uid');
            location.reload();
        };

        function hideElement(id) {
            const el = document.getElementById(id);
            if(el) el.classList.add('hidden');
        }
        function showElement(id) {
            const el = document.getElementById(id);
            if(el) el.classList.remove('hidden');
        }

        function showLoginModal() {
            hideElement('system-loading');
            showElement('login-modal');
            hideElement('app-container');
        }

        function showApp() {
            if (!appUser) return;
            hideElement('system-loading');
            hideElement('login-modal');
            showElement('app-container');
            
            const usernameEl = document.getElementById('sidebar-username');
            const roleEl = document.getElementById('sidebar-role');
            if (usernameEl) usernameEl.innerText = appUser.name;
            if (roleEl) roleEl.innerText = appUser.role === 'admin' ? '管理员' : '督导老师';
            
            const adminNav = document.getElementById('nav-admin');
            if (adminNav) {
                if (appUser.role === 'admin') adminNav.classList.remove('hidden');
                else adminNav.classList.add('hidden');
            }

            resetForm(); 
            window.loadEvaluations();
        }

        // ================= 核心业务逻辑 (CRUD) =================

        window.startNewEvaluation = () => {
            if (!appUser) return showLoginModal();
            resetForm();
            window.switchPage('tool');
        }

        function resetForm() {
            const form = document.getElementById('evaluation-form');
            if (form) form.reset();
            const editId = document.getElementById('editRecordId');
            if (editId) editId.value = ""; 
            
            const supName = document.getElementById('supervisorName');
            if (supName) supName.value = appUser ? appUser.name : ''; 
            
            try { document.getElementById('date').valueAsDate = new Date(); } catch(e){}
            document.querySelectorAll('.check-item').forEach(el => el.classList.remove('checked'));
            
            const title = document.getElementById('tool-title');
            if(title) title.innerText = "新建评估记录";
            const sub = document.getElementById('tool-subtitle');
            if(sub) sub.innerText = "请基于“有趣·有效·有用”的核心价值观进行客观评价";
            
            const saveBtn = document.getElementById('save-btn');
            if(saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-save mr-2"></i> 生成评估报告';
                saveBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
                saveBtn.classList.add('bg-jhblue', 'hover:bg-sky-600');
            }
            
            const cancelBtn = document.getElementById('cancel-edit-btn');
            if(cancelBtn) cancelBtn.classList.add('hidden');
        }

        window.switchPage = (pageId) => {
            if (!appUser) { showLoginModal(); return; }
            if (pageId === 'admin' && appUser.role !== 'admin') { alert("无权限访问"); return; }
            
            ['home-view', 'tool-view', 'data-view', 'admin-view'].forEach(id => hideElement(id));
            hideElement('report-view');
            showElement(pageId + '-view');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navBtn = document.getElementById('nav-' + pageId);
            if(navBtn) navBtn.classList.add('active');

            if (pageId === 'admin') window.loadAllUsers();
            if (pageId === 'data') window.loadEvaluations();
        }

        // 收集表单数据 + 保存 + 渲染
        window.handleGenerateAndSave = () => {
            const getVal = (id) => { const el = document.getElementById(id); return el ? (parseInt(el.value) || 0) : 0; };
            const getText = (id) => { const el = document.getElementById(id); return el ? el.value : ""; };
            
            const scores = [getVal('scoreFun'), getVal('scoreEff'), getVal('scoreUse'), getVal('scoreAwareness'), getVal('scoreResult')];
            const total = scores.reduce((a,b) => a+b, 0);
            
            let level = "C 需改进";
            if (total >= 90) level = "A+ 卓越";
            else if (total >= 85) level = "A 高效";
            else if (total >= 75) level = "B 合格";

            const data = {
                supervisorName: getText('supervisorName'),
                teacherName: getText('teacherName'),
                courseType: getText('courseType'),
                topic: getText('topic'),
                date: getText('date'),
                scores: scores,
                totalScore: total,
                level: level,
                tags: {
                    fun: getSelectedTags('tags-fun'),
                    eff: getSelectedTags('tags-eff'),
                    use: getSelectedTags('tags-use')
                },
                feedbacks: {
                    fun: getText('textFun'),
                    eff: getText('textEff'),
                    use: getText('textUse'),
                    awareness: getText('textAwareness'),
                    result: getText('textResult'),
                    overall: getText('textOverallImprovement'),
                    verdict: getText('textFinalVerdict')
                }
            };

            window.saveEvaluationToDB(data);
            window.renderReport(data);
        }

        window.loadRecordForEdit = (id) => {
            if (!window.cachedEvaluations) return;
            const record = window.cachedEvaluations.find(e => e.id === id);
            if (!record) return alert("记录未找到或已删除");

            const editIdInput = document.getElementById('editRecordId');
            if(editIdInput) editIdInput.value = record.id;
            
            const setVal = (eid, val) => { const el = document.getElementById(eid); if(el) el.value = val || ''; };
            
            setVal('supervisorName', record.supervisorName); 
            setVal('teacherName', record.teacherName);
            setVal('date', record.date);
            setVal('courseType', record.courseType || '常规课');
            setVal('topic', record.topic);
            
            const scores = record.scores || [0,0,0,0,0];
            setVal('scoreFun', scores[0]);
            setVal('scoreEff', scores[1]);
            setVal('scoreUse', scores[2]);
            setVal('scoreAwareness', scores[3]);
            setVal('scoreResult', scores[4]);

            const fb = record.feedbacks || {};
            setVal('textFun', fb.fun);
            setVal('textEff', fb.eff);
            setVal('textUse', fb.use);
            setVal('textAwareness', fb.awareness);
            setVal('textResult', fb.result);
            setVal('textOverallImprovement', fb.overall);
            setVal('textFinalVerdict', fb.verdict);

            const tags = record.tags || {};
            setTags('tags-fun', tags.fun || []);
            setTags('tags-eff', tags.eff || []);
            setTags('tags-use', tags.use || []);

            const title = document.getElementById('tool-title');
            if(title) title.innerText = "编辑记录";
            const sub = document.getElementById('tool-subtitle');
            if(sub) sub.innerText = "正在修改历史记录，保存后将覆盖原数据";
            const saveBtn = document.getElementById('save-btn');
            if(saveBtn) {
                saveBtn.innerHTML = '<i class="fas fa-sync-alt mr-2"></i> 更新记录';
                saveBtn.classList.remove('bg-jhblue', 'hover:bg-sky-600');
                saveBtn.classList.add('bg-green-600', 'hover:bg-green-700'); 
            }
            const cancelBtn = document.getElementById('cancel-edit-btn');
            if(cancelBtn) cancelBtn.classList.remove('hidden');
            
            window.switchPage('tool');
        };

        window.saveEvaluationToDB = async (data) => {
            if (!appUser) return;
            const editIdInput = document.getElementById('editRecordId');
            const editRecordId = editIdInput ? editIdInput.value : "";
            const isUpdate = !!editRecordId;

            const record = {
                ...data,
                timestamp: Date.now(),
                dateStr: new Date().toLocaleDateString()
            };

            if (isLocalMode) {
                let localData = JSON.parse(localStorage.getItem('jh_evaluations') || '[]');
                if (isUpdate) {
                    const index = localData.findIndex(item => item.id === editRecordId);
                    if (index !== -1) {
                        record.id = editRecordId;
                        record.creatorId = localData[index].creatorId;
                        record.creatorName = localData[index].creatorName;
                        localData[index] = record;
                    }
                } else {
                    record.id = 'local_' + Date.now();
                    record.creatorId = appUser.uid;
                    record.creatorName = appUser.name;
                    localData.push(record);
                }
                localStorage.setItem('jh_evaluations', JSON.stringify(localData));
                showToast(isUpdate ? "✅ 记录已更新" : "✅ 记录已保存");
                await window.loadEvaluations();
            } else {
                try {
                    if (isUpdate) {
                        await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'jh_evaluations', editRecordId), record);
                        showToast("✅ 云端记录已更新");
                    } else {
                        // New record: attach creator
                        record.creatorId = appUser.uid;
                        record.creatorName = appUser.name;
                        const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'jh_evaluations');
                        await addDoc(colRef, record);
                        showToast("✅ 云端记录已保存");
                    }
                    await window.loadEvaluations();
                } catch (e) {
                    console.error(e);
                    alert("保存失败: " + e.message);
                }
            }
        };

        window.deleteEvaluation = async (docId) => {
            if(!confirm("确定要永久删除这条听课记录吗？")) return;

            if (isLocalMode) {
                let localData = JSON.parse(localStorage.getItem('jh_evaluations') || '[]');
                localData = localData.filter(item => item.id !== docId);
                localStorage.setItem('jh_evaluations', JSON.stringify(localData));
                showToast("已删除");
            } else {
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'jh_evaluations', docId));
                    showToast("已从云端删除");
                } catch(e) { alert("删除失败"); }
            }
            await window.loadEvaluations();
        };

        window.loadEvaluations = async () => {
            if (!appUser) return;
            let evaluations = [];
            const tbody = document.getElementById('data-table-body');
            if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-slate-400"><i class="fas fa-spinner fa-spin mr-2"></i>加载数据中...</td></tr>`;

            try {
                if (isLocalMode) {
                    const raw = localStorage.getItem('jh_evaluations');
                    if (raw) evaluations = JSON.parse(raw);
                } else {
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'jh_evaluations');
                    const q = query(colRef);
                    const snapshot = await getDocs(q);
                    snapshot.forEach((doc) => {
                        evaluations.push({ id: doc.id, ...doc.data() });
                    });
                }

                let filteredEvaluations = evaluations;
                if (appUser.role !== 'admin') {
                    filteredEvaluations = evaluations.filter(e => e.creatorId === appUser.uid);
                }

                filteredEvaluations.sort((a, b) => b.timestamp - a.timestamp);
                window.cachedEvaluations = filteredEvaluations;

                renderTableGlobal(filteredEvaluations);
                updateDashboardGlobal(filteredEvaluations);

            } catch (error) {
                console.error(error);
                if(tbody) tbody.innerHTML = `<tr><td colspan="7" class="text-center text-red-400 p-4">数据加载异常</td></tr>`;
            }
        };

        // ================= 辅助函数 =================

        function renderTableGlobal(evaluations) {
            const tbody = document.getElementById('data-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            if(evaluations.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="p-8 text-center text-slate-400">暂无数据</td></tr>';
                return;
            }
            evaluations.forEach(item => {
                const tr = document.createElement('tr');
                tr.className = "border-b hover:bg-slate-50 transition";
                let badgeClass = "bg-gray-100 text-gray-700";
                if (item.level.includes("A")) badgeClass = "bg-green-100 text-green-700";
                else if (item.level.includes("B")) badgeClass = "bg-blue-100 text-blue-700";
                else if (item.level.includes("C")) badgeClass = "bg-red-100 text-red-700";

                const isMine = item.creatorId === appUser.uid;
                const isAdmin = appUser.role === 'admin';
                const canEdit = isMine || isAdmin;
                const canDelete = isAdmin; 

                tr.innerHTML = `
                    <td class="p-4">
                        <div class="font-bold text-slate-700">${item.date}</div>
                        <div class="text-xs text-slate-400 mt-1">${item.courseType || '常规课'}</div>
                    </td>
                    <td class="p-4 text-slate-600 text-sm">${item.supervisorName || '-'}</td>
                    <td class="p-4 font-medium">${item.teacherName}</td>
                    <td class="p-4 text-slate-500 text-sm max-w-xs truncate">${item.topic}</td>
                    <td class="p-4 font-bold text-jhblue">${item.totalScore}</td>
                    <td class="p-4"><span class="px-2 py-1 rounded text-xs font-bold ${badgeClass}">${item.level.split(' ')[0]}</span></td>
                    <td class="p-4 flex gap-3">
                        <button onclick="window.viewRecordGlobal('${item.id}')" class="text-gray-500 hover:text-jhblue text-sm" title="查看"><i class="fas fa-eye"></i></button>
                        ${canEdit ? `<button onclick="window.loadRecordForEdit('${item.id}')" class="text-blue-600 hover:text-blue-800 text-sm" title="编辑"><i class="fas fa-edit"></i></button>` : ''}
                        ${canDelete ? `<button onclick="window.deleteEvaluation('${item.id}')" class="text-red-400 hover:text-red-600 text-sm" title="删除"><i class="fas fa-trash"></i></button>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateDashboardGlobal(evaluations) {
            const statTotal = document.getElementById('stat-total');
            if(statTotal) statTotal.innerText = evaluations.length;
            
            const now = new Date();
            const thisMonth = evaluations.filter(e => {
                const d = new Date(e.timestamp);
                return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
            }).length;
            const statMonth = document.getElementById('stat-month');
            if(statMonth) statMonth.innerText = thisMonth;

            if (evaluations.length > 0) {
                const total = evaluations.reduce((sum, e) => sum + (e.totalScore || 0), 0);
                const statAvg = document.getElementById('stat-avg');
                if(statAvg) statAvg.innerText = (total / evaluations.length).toFixed(1);
            }

            const activityList = document.getElementById('recent-activity');
            if(activityList) {
                activityList.innerHTML = '';
                if(evaluations.length === 0) activityList.innerHTML = '<p class="text-sm text-slate-400 py-4 text-center">暂无动态</p>';
                evaluations.slice(0, 3).forEach(item => {
                    const div = document.createElement('div');
                    div.className = "flex justify-between items-center p-3 bg-slate-50 rounded-lg hover:bg-slate-100 transition cursor-pointer";
                    div.onclick = () => window.viewRecordGlobal(item.id);
                    div.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-2 h-2 rounded-full bg-jhblue"></div>
                            <div>
                                <div class="font-bold text-sm text-slate-700">${item.teacherName} <span class="font-normal text-xs text-slate-400">(${item.courseType})</span></div>
                                <div class="text-xs text-slate-500">${item.date} · ${item.supervisorName}</div>
                            </div>
                        </div>
                        <div class="font-bold text-jhblue">${item.totalScore}分</div>
                    `;
                    activityList.appendChild(div);
                });
            }
        }

        window.viewRecordGlobal = (id) => {
            const record = window.cachedEvaluations.find(e => e.id === id);
            if(record) window.renderReport(record);
        }

        window.renderReport = (data) => {
            try {
                const setText = (id, txt) => {
                    const el = document.getElementById(id);
                    if(el) el.innerText = txt || "";
                }
                setText('displaySupervisor', data.supervisorName);
                setText('displayTeacher', data.teacherName);
                setText('displayCourseType', data.courseType);
                setText('displayTopic', data.topic);
                setText('displayDate', data.date);
                setText('displayTotalScore', data.totalScore || 0);
                setText('displayLevel', (data.level || "").split(' ')[0]);

                const mapFeed = (id, text) => { const el = document.getElementById(id); if(el) el.innerText = text || "暂无评价"; };
                mapFeed('feedFunDisplay', data.feedbacks.fun);
                mapFeed('feedEffDisplay', data.feedbacks.eff);
                mapFeed('feedUseDisplay', data.feedbacks.use);
                mapFeed('feedAwarenessDisplayReport', data.feedbacks.awareness);
                mapFeed('feedResultDisplayReport', data.feedbacks.result);
                mapFeed('displayOverallImprovementReport', data.feedbacks.overall);
                mapFeed('displayFinalVerdictReport', data.feedbacks.verdict);

                const mapTags = (id, tags) => { const el = document.getElementById(id); if(el) el.innerText = (tags || []).join(' / '); };
                mapTags('tag-fun', data.tags.fun);
                mapTags('tag-eff', data.tags.eff);
                mapTags('tag-use', data.tags.use);

                showElement('report-view');

                setTimeout(() => {
                    const ctx = document.getElementById('radarChart').getContext('2d');
                    if (myChart) myChart.destroy();
                    myChart = new Chart(ctx, {
                        type: 'radar',
                        data: {
                            labels: ['有趣', '有效', '有用', '感知', '结果'],
                            datasets: [{
                                label: '得分',
                                data: data.scores,
                                fill: true,
                                backgroundColor: 'rgba(0, 159, 232, 0.2)',
                                borderColor: '#009FE8',
                                pointBackgroundColor: '#FF6B6B',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: '#FF6B6B'
                            }]
                        },
                        options: {
                            scales: { r: { suggestedMin: 0, suggestedMax: 20, ticks: { display: false } } },
                            plugins: { legend: { display: false } },
                            maintainAspectRatio: false
                        }
                    });
                }, 100);
            } catch(e) {
                console.error("Report Render Error", e);
                alert("报告生成失败，请检查数据完整性");
            }
        }

        window.closeReport = () => {
            hideElement('report-view');
            window.switchPage('tool');
        }

        // 终极截图修复版
        window.saveReportAsImage = async () => {
            const original = document.getElementById('report-container');
            const overlay = document.getElementById('loading-overlay');
            if(overlay) overlay.style.display = 'flex';
            
            try {
                const clone = original.cloneNode(true);
                clone.classList.add('report-clone-container'); 
                
                const origCanvas = original.querySelector('canvas');
                const cloneCanvas = clone.querySelector('canvas');
                if (origCanvas && cloneCanvas) {
                    const img = document.createElement('img');
                    img.src = origCanvas.toDataURL();
                    img.style.width = '100%';
                    img.style.height = '100%'; 
                    cloneCanvas.parentNode.replaceChild(img, cloneCanvas);
                }

                clone.style.position = 'fixed';
                clone.style.top = '0';
                clone.style.left = '-9999px'; 
                clone.style.width = '800px'; 
                clone.style.height = 'auto';
                clone.style.zIndex = '-1';
                clone.style.background = '#ffffff'; 
                clone.style.borderRadius = '0';
                clone.style.boxShadow = 'none';

                document.body.appendChild(clone);

                const canvas = await html2canvas(clone, {
                    scale: 2, 
                    useCORS: true,
                    backgroundColor: '#ffffff',
                    windowWidth: 800,
                    scrollY: 0,
                    scrollX: 0
                });

                const link = document.createElement('a');
                const teacherName = document.getElementById('displayTeacher') ? document.getElementById('displayTeacher').innerText : "报告";
                link.download = `督导反馈_${teacherName}.png`;
                link.href = canvas.toDataURL();
                link.click();

                document.body.removeChild(clone);
            } catch (e) {
                console.error(e);
                alert("生成图片失败，请截图保存");
            } finally {
                if(overlay) overlay.style.display = 'none';
            }
        }

        window.toggleCheck = function(el) { el.classList.toggle('checked'); }
        window.showToast = function(msg) {
            const t = document.getElementById('toast-container');
            if(t) {
                document.getElementById('toast-message').innerText = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
        }
        function getSelectedTags(id) {
            const container = document.getElementById(id);
            return container ? Array.from(container.querySelectorAll('.check-item.checked')).map(e => e.innerText) : [];
        }
        function setTags(id, tags) {
            const container = document.getElementById(id);
            if (!container) return;
            const items = container.querySelectorAll('.check-item');
            items.forEach(item => {
                if (tags.includes(item.innerText)) item.classList.add('checked');
                else item.classList.remove('checked');
            });
        }

        // CSV导出
        window.exportToCSV = () => {
            if (!window.cachedEvaluations || !window.cachedEvaluations.length) return alert("无数据");
            let csv = "\ufeff日期,课程类型,督导,教师,课题,总分,评级,建议\n";
            window.cachedEvaluations.forEach(e => {
                const safe = (t) => `"${(t||'').toString().replace(/"/g,'""')}"`;
                csv += `${safe(e.date)},${safe(e.courseType)},${safe(e.supervisorName)},${safe(e.teacherName)},${safe(e.topic)},${e.totalScore},${safe(e.level)},${safe(e.feedbacks.overall)}\n`;
            });
            const blob = new Blob([csv], {type: 'text/csv;charset=utf-8'});
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `家辉培优_督导记录_${new Date().toLocaleDateString()}.csv`;
            link.click();
        }

        // 用户管理
        window.loadAllUsers = async () => {
            if (!appUser || appUser.role !== 'admin') return;
            const tbody = document.getElementById('user-table-body');
            if (!tbody) return;
            tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center"><i class="fas fa-spinner fa-spin"></i> 加载人员列表...</td></tr>';

            let users = [];
            if (isLocalMode) {
                users = JSON.parse(localStorage.getItem('jh_users_db') || '[]');
            } else {
                try {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'jh_users');
                    const snapshot = await getDocs(query(usersRef));
                    snapshot.forEach(doc => users.push({ ...doc.data(), id: doc.id }));
                } catch (e) {
                    console.error("Load users failed:", e);
                    tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-red-500">加载失败</td></tr>';
                    return;
                }
            }
            renderUserTable(users);
        }

        function renderUserTable(users) {
            const tbody = document.getElementById('user-table-body');
            if (!tbody) return;
            tbody.innerHTML = '';
            if(users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="p-4 text-center text-slate-400">暂无用户，请点击上方添加</td></tr>';
            }
            users.forEach(u => {
                const isMe = appUser && u.uid === appUser.uid;
                tbody.innerHTML += `
                    <tr class="border-b hover:bg-slate-50 transition">
                        <td class="p-4 font-bold text-slate-700">${u.name}</td>
                        <td class="p-4 text-slate-600 font-mono text-sm">${u.username}</td>
                        <td class="p-4 font-mono text-xs text-slate-400">
                            <span onclick="alert('该用户密码为: ${u.password}')" class="cursor-pointer hover:text-jhblue" title="点击查看">******</span>
                        </td>
                        <td class="p-4">
                            <span class="px-2 py-1 rounded text-xs border ${u.role === 'admin' ? 'bg-purple-50 text-purple-700 border-purple-200' : 'bg-blue-50 text-blue-700 border-blue-200'}">
                                ${u.role === 'admin' ? '管理员' : '督导'}
                            </span>
                        </td>
                        <td class="p-4 flex gap-2">
                            ${!isMe ? `
                            <button onclick="window.toggleRole('${u.id}', '${u.role}', '${u.name}')" class="text-blue-500 hover:text-blue-700 text-xs px-2 py-1 border border-blue-200 rounded">
                                <i class="fas fa-user-shield"></i> 权限
                            </button>
                            <button onclick="window.deleteUser('${u.id}', '${u.uid}')" class="text-red-500 hover:text-red-700 text-xs px-2 py-1 border border-red-200 rounded">
                                <i class="fas fa-trash"></i> 删除
                            </button>` : '<span class="text-xs text-gray-300">当前用户</span>'}
                        </td>
                    </tr>
                `;
            });
        }

        window.addUser = async () => {
            if (!appUser || appUser.role !== 'admin') return;
            const name = document.getElementById('new-name').value.trim();
            const username = document.getElementById('new-username').value.trim();
            const password = document.getElementById('new-password').value.trim();
            const role = document.getElementById('new-role').value;

            if(!name || !username || !password) return alert("请填写完整的账号信息");

            const newUser = {
                name, username, password, role,
                uid: 'user_' + Date.now() + Math.random().toString(36).substr(2, 9),
                createdAt: Date.now()
            };

            if (isLocalMode) {
                let users = JSON.parse(localStorage.getItem('jh_users_db') || '[]');
                if(users.find(u => u.username === username)) return alert("账号已存在");
                users.push(newUser);
                localStorage.setItem('jh_users_db', JSON.stringify(users));
                showToast("添加成功");
            } else {
                try {
                    const usersRef = collection(db, 'artifacts', appId, 'public', 'data', 'jh_users');
                    const q = query(usersRef, where("username", "==", username));
                    const snap = await getDocs(q);
                    if (!snap.empty) return alert("账号已存在，请更换账号名");
                    await addDoc(usersRef, newUser);
                    showToast("添加成功");
                } catch(e) { alert("添加失败: " + e.message); }
            }
            
            document.getElementById('new-name').value = '';
            document.getElementById('new-username').value = '';
            document.getElementById('new-password').value = '';
            window.loadAllUsers();
        };

        window.toggleRole = async (docId, currentRole, name) => {
            if (!appUser || appUser.role !== 'admin') return;
            const newRole = currentRole === 'admin' ? 'supervisor' : 'admin';
            const actionText = newRole === 'admin' ? '提拔为管理员' : '降级为普通督导';
            if(!confirm(`确定要将 [${name}] ${actionText} 吗？`)) return;

            if (isLocalMode) {
                let users = JSON.parse(localStorage.getItem('jh_users_db') || '[]');
                const idx = users.findIndex(u => u.id === docId || u.uid === docId);
                if(idx !== -1) users[idx].role = newRole;
                localStorage.setItem('jh_users_db', JSON.stringify(users));
                showToast("权限已修改");
            } else {
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'jh_users', docId), { role: newRole });
                    showToast("权限已修改");
                } catch(e) { alert("修改失败"); }
            }
            window.loadAllUsers();
        };

        window.deleteUser = async (docId, uid) => {
            if (!appUser || appUser.role !== 'admin') return;
            if(!confirm("⚠️ 警告：确定删除该账号吗？该操作无法撤销。")) return;
            if (isLocalMode) {
                let users = JSON.parse(localStorage.getItem('jh_users_db') || '[]');
                users = users.filter(u => u.uid !== uid);
                localStorage.setItem('jh_users_db', JSON.stringify(users));
                showToast("用户已删除");
            } else {
                try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'jh_users', docId)); showToast("用户已删除"); } 
                catch(e) { alert("删除失败"); }
            }
            window.loadAllUsers();
        };

        // 启动系统，等待 DOM
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => initSystem());
        } else {
            initSystem();
        }
    </script>
</body>
</html>
